<!DOCTYPE html>
<html lang="id">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>JSON Formatter, Diff & Snippets</title>
  <link
    href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600&family=Syne:wght@400;700;800&display=swap"
    rel="stylesheet">
  <style>
    :root {
      --bg: #0d0f14;
      --surface: #141720;
      --surface2: #1c2030;
      --border: #252a3a;
      --accent: #00e5a0;
      --accent2: #0088ff;
      --text: #e8eaf0;
      --muted: #5a6080;
      --error: #ff4d6a;
      --key: #79b8ff;
      --string: #9ecbff;
      --number: #f8c555;
      --bool: #ff9f7f;
      --null: #ff4d6a;
      --bracket: #888faa;
      --added: #00e5a0;
      --added-bg: rgba(0, 229, 160, .08);
      --removed: #ff4d6a;
      --removed-bg: rgba(255, 77, 106, .08);
      --changed: #f8c555;
      --changed-bg: rgba(248, 197, 85, .08);
      --identical: #5a6080;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Syne', sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    body::before {
      content: '';
      position: fixed;
      inset: 0;
      background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.04'/%3E%3C/svg%3E");
      pointer-events: none;
      z-index: 0;
    }

    /* HEADER */
    header {
      padding: 18px 40px 14px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      gap: 14px;
      position: relative;
      z-index: 10;
      flex-wrap: wrap;
    }

    .logo {
      width: 36px;
      height: 36px;
      background: var(--accent);
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      flex-shrink: 0;
    }

    h1 {
      font-size: 22px;
      font-weight: 800;
      letter-spacing: -.5px;
    }

    h1 span {
      color: var(--accent);
    }

    .tabs {
      display: flex;
      gap: 4px;
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 4px;
      margin-left: 12px;
    }

    .tab-btn {
      font-family: 'JetBrains Mono', monospace;
      font-size: 11px;
      font-weight: 700;
      padding: 6px 16px;
      border: none;
      border-radius: 6px;
      background: transparent;
      color: var(--muted);
      cursor: pointer;
      transition: all .18s;
      letter-spacing: .5px;
      white-space: nowrap;
    }

    .tab-btn:hover {
      color: var(--text);
      border-color: transparent;
    }

    .tab-btn.active {
      background: var(--accent);
      color: #000;
      border-color: transparent;
    }

    .tab-btn.active:hover {
      background: #00ffb3;
      color: #000;
    }

    .tab-badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      background: #fff2;
      border-radius: 999px;
      font-size: 9px;
      padding: 1px 5px;
      margin-left: 4px;
      min-width: 16px;
    }

    .tab-btn.active .tab-badge {
      background: rgba(0, 0, 0, .2);
    }

    .subtitle {
      font-family: 'JetBrains Mono', monospace;
      font-size: 11px;
      color: var(--muted);
      margin-left: auto;
      letter-spacing: 1px;
    }

    /* VIEWS */
    #formatter-view {
      flex: 1;
      display: none;
      grid-template-columns: 1fr 1fr;
      position: relative;
      z-index: 1;
    }

    #formatter-view.active {
      display: grid;
    }

    #diff-view {
      flex: 1;
      display: none;
      flex-direction: column;
      position: relative;
      z-index: 1;
    }

    #diff-view.active {
      display: flex;
    }

    #snippets-view {
      flex: 1;
      display: none;
      flex-direction: row;
      position: relative;
      z-index: 1;
      overflow: hidden;
    }

    #snippets-view.active {
      display: flex;
    }

    /* PANELS */
    .panel {
      display: flex;
      flex-direction: column;
      border-right: 1px solid var(--border);
    }

    .panel:last-child {
      border-right: none;
    }

    .panel-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 20px;
      border-bottom: 1px solid var(--border);
      background: var(--surface);
      gap: 10px;
      flex-shrink: 0;
    }

    .panel-label {
      font-size: 11px;
      font-weight: 700;
      letter-spacing: 2px;
      text-transform: uppercase;
      color: var(--muted);
    }

    .panel-actions {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    button {
      font-family: 'JetBrains Mono', monospace;
      font-size: 11px;
      font-weight: 600;
      padding: 6px 14px;
      border: 1px solid var(--border);
      border-radius: 6px;
      background: var(--surface2);
      color: var(--text);
      cursor: pointer;
      transition: all .15s;
      display: flex;
      align-items: center;
      gap: 6px;
      white-space: nowrap;
    }

    button:hover {
      border-color: var(--accent);
      color: var(--accent);
    }

    button.primary {
      background: var(--accent);
      color: #000;
      border-color: var(--accent);
      font-weight: 700;
    }

    button.primary:hover {
      background: #00ffb3;
      border-color: #00ffb3;
      color: #000;
    }

    button.danger:hover {
      border-color: var(--removed);
      color: var(--removed);
    }

    button.icon-btn {
      padding: 6px 10px;
    }

    textarea {
      flex: 1;
      background: var(--surface);
      border: none;
      color: var(--text);
      font-family: 'JetBrains Mono', monospace;
      font-size: 12.5px;
      line-height: 1.7;
      padding: 20px;
      resize: none;
      outline: none;
      min-height: 500px;
    }

    textarea::placeholder {
      color: var(--muted);
    }

    textarea.diff-ta {
      min-height: unset;
      height: 100%;
    }

    #output-area {
      flex: 1;
      background: var(--surface);
      overflow: auto;
      min-height: 500px;
      padding: 20px;
    }

    #output-area pre {
      font-family: 'JetBrains Mono', monospace;
      font-size: 12.5px;
      line-height: 1.7;
      white-space: pre-wrap;
      word-break: break-all;
    }

    /* DIFF */
    .diff-inputs {
      display: grid;
      grid-template-columns: 1fr 1fr;
      border-bottom: 1px solid var(--border);
      height: 260px;
    }

    .diff-output-wrap {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    #diff-output {
      flex: 1;
      background: var(--surface);
      overflow: auto;
      padding: 20px;
      font-family: 'JetBrains Mono', monospace;
      font-size: 12.5px;
      line-height: 1.7;
    }

    .diff-summary {
      display: flex;
      gap: 20px;
      padding: 10px 20px;
      background: var(--surface2);
      border-bottom: 1px solid var(--border);
      font-family: 'JetBrains Mono', monospace;
      font-size: 11px;
      flex-wrap: wrap;
    }

    .diff-summary .badge {
      display: flex;
      align-items: center;
      gap: 6px;
      font-weight: 700;
    }

    .badge.added {
      color: var(--added);
    }

    .badge.removed {
      color: var(--removed);
    }

    .badge.changed {
      color: var(--changed);
    }

    .badge.identical {
      color: var(--identical);
    }

    .diff-entry {
      display: flex;
      align-items: flex-start;
      gap: 10px;
      padding: 6px 12px;
      border-radius: 6px;
      margin-bottom: 4px;
      font-size: 12px;
    }

    .diff-entry.added {
      background: var(--added-bg);
      border-left: 3px solid var(--added);
    }

    .diff-entry.removed {
      background: var(--removed-bg);
      border-left: 3px solid var(--removed);
    }

    .diff-entry.changed {
      background: var(--changed-bg);
      border-left: 3px solid var(--changed);
    }

    .diff-sign {
      font-weight: 700;
      font-size: 14px;
      flex-shrink: 0;
      width: 16px;
      text-align: center;
    }

    .added .diff-sign {
      color: var(--added);
    }

    .removed .diff-sign {
      color: var(--removed);
    }

    .changed .diff-sign {
      color: var(--changed);
    }

    .diff-path {
      color: var(--key);
      flex-shrink: 0;
      min-width: 160px;
      max-width: 280px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .diff-value {
      color: var(--muted);
      flex: 1;
      word-break: break-all;
      white-space: pre-wrap;
    }

    .diff-arrow {
      color: var(--muted);
      flex-shrink: 0;
    }

    .diff-old {
      color: var(--removed);
    }

    .diff-new {
      color: var(--added);
    }

    .diff-section-label {
      font-size: 10px;
      letter-spacing: 2px;
      text-transform: uppercase;
      color: var(--muted);
      padding: 12px 12px 4px;
      font-weight: 700;
    }

    .swap-btn {
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: 50%;
      width: 32px;
      height: 32px;
      padding: 0;
      font-size: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all .2s;
      flex-shrink: 0;
    }

    .swap-btn:hover {
      border-color: var(--accent);
      color: var(--accent);
      transform: rotate(180deg);
    }

    /* SNIPPETS VIEW */
    .snip-sidebar {
      width: 300px;
      flex-shrink: 0;
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      background: var(--surface);
    }

    .snip-sidebar-header {
      padding: 14px 16px;
      border-bottom: 1px solid var(--border);
      background: var(--surface2);
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .snip-search {
      width: 100%;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text);
      font-family: 'JetBrains Mono', monospace;
      font-size: 11px;
      padding: 7px 12px;
      outline: none;
      transition: border-color .15s;
    }

    .snip-search:focus {
      border-color: var(--accent);
    }

    .snip-search::placeholder {
      color: var(--muted);
    }

    .snip-list {
      flex: 1;
      overflow-y: auto;
      padding: 8px;
    }

    .snip-section-title {
      font-size: 9px;
      letter-spacing: 2px;
      text-transform: uppercase;
      color: var(--muted);
      font-weight: 700;
      padding: 10px 8px 4px;
    }

    .snip-card {
      padding: 10px 12px;
      border-radius: 8px;
      cursor: pointer;
      transition: all .15s;
      border: 1px solid transparent;
      margin-bottom: 4px;
    }

    .snip-card:hover {
      background: var(--surface2);
      border-color: var(--border);
    }

    .snip-card.selected {
      background: var(--surface2);
      border-color: var(--accent);
    }

    .snip-card-name {
      font-size: 12px;
      font-weight: 700;
      margin-bottom: 3px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .snip-card-preview {
      font-family: 'JetBrains Mono', monospace;
      font-size: 10px;
      color: var(--muted);
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .snip-card-meta {
      font-family: 'JetBrains Mono', monospace;
      font-size: 9px;
      color: var(--muted);
      margin-top: 4px;
      display: flex;
      gap: 8px;
    }

    .snip-source-badge {
      font-size: 8px;
      padding: 1px 5px;
      border-radius: 3px;
      font-weight: 700;
      letter-spacing: .5px;
    }

    .snip-source-badge.formatter {
      background: rgba(0, 136, 255, .15);
      color: var(--accent2);
    }

    .snip-source-badge.diff-a {
      background: rgba(255, 77, 106, .12);
      color: var(--removed);
    }

    .snip-source-badge.diff-b {
      background: rgba(0, 229, 160, .12);
      color: var(--added);
    }

    .snip-empty {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 40px 20px;
      color: var(--muted);
      font-family: 'JetBrains Mono', monospace;
      font-size: 11px;
      text-align: center;
      gap: 8px;
    }

    .snip-empty .ei {
      font-size: 28px;
      opacity: .3;
    }

    /* Snippet Preview pane */
    .snip-preview {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .snip-preview-header {
      padding: 12px 20px;
      border-bottom: 1px solid var(--border);
      background: var(--surface2);
      display: flex;
      align-items: center;
      gap: 10px;
      flex-shrink: 0;
    }

    .snip-preview-title {
      font-size: 13px;
      font-weight: 700;
      flex: 1;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .snip-preview-body {
      flex: 1;
      overflow: auto;
      padding: 20px;
      background: var(--surface);
      font-family: 'JetBrains Mono', monospace;
      font-size: 12.5px;
      line-height: 1.7;
    }

    .snip-preview-body pre {
      white-space: pre-wrap;
      word-break: break-all;
    }

    .snip-no-sel {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      color: var(--muted);
      font-family: 'JetBrains Mono', monospace;
      font-size: 12px;
      gap: 10px;
    }

    .snip-no-sel .icon {
      font-size: 32px;
      opacity: .25;
    }

    .snip-preview-actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    /* Modal */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, .65);
      backdrop-filter: blur(4px);
      z-index: 1000;
      display: none;
      align-items: center;
      justify-content: center;
    }

    .modal-overlay.open {
      display: flex;
    }

    .modal-box {
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 28px;
      width: 380px;
      display: flex;
      flex-direction: column;
      gap: 16px;
      box-shadow: 0 24px 60px rgba(0, 0, 0, .5);
    }

    .modal-title {
      font-size: 16px;
      font-weight: 800;
    }

    .modal-label {
      font-size: 11px;
      color: var(--muted);
      font-family: 'JetBrains Mono', monospace;
      margin-bottom: 6px;
    }

    .modal-input {
      width: 100%;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text);
      font-family: 'JetBrains Mono', monospace;
      font-size: 13px;
      padding: 10px 14px;
      outline: none;
      transition: border-color .15s;
    }

    .modal-input:focus {
      border-color: var(--accent);
    }

    .modal-actions {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
    }

    /* Syntax */
    .j-key {
      color: var(--key);
    }

    .j-str {
      color: var(--string);
    }

    .j-num {
      color: var(--number);
    }

    .j-bool {
      color: var(--bool);
    }

    .j-null {
      color: var(--null);
    }

    .j-brk {
      color: var(--bracket);
    }

    .error-msg {
      color: var(--error);
      font-family: 'JetBrains Mono', monospace;
      font-size: 12px;
      padding: 16px 20px;
      background: rgba(255, 77, 106, .08);
      border-left: 3px solid var(--error);
      margin: 20px;
      border-radius: 4px;
    }

    .empty-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      color: var(--muted);
      gap: 12px;
      font-family: 'JetBrains Mono', monospace;
      font-size: 12px;
    }

    .empty-state .icon {
      font-size: 36px;
      opacity: .3;
    }

    footer {
      padding: 14px 40px;
      border-top: 1px solid var(--border);
      display: flex;
      align-items: center;
      gap: 16px;
      font-family: 'JetBrains Mono', monospace;
      font-size: 11px;
      color: var(--muted);
      position: relative;
      z-index: 1;
    }

    #status {
      margin-left: auto;
    }

    #status.ok {
      color: var(--accent);
    }

    #status.err {
      color: var(--error);
    }

    #diff-status.ok {
      color: var(--accent);
    }

    #diff-status.err {
      color: var(--error);
    }

    .toast {
      position: fixed;
      bottom: 28px;
      right: 28px;
      background: var(--accent);
      color: #000;
      font-family: 'JetBrains Mono', monospace;
      font-size: 12px;
      font-weight: 700;
      padding: 10px 20px;
      border-radius: 8px;
      opacity: 0;
      transform: translateY(10px);
      transition: all .2s;
      pointer-events: none;
      z-index: 9999;
    }

    .toast.show {
      opacity: 1;
      transform: translateY(0);
    }

    @media(max-width:768px) {
      #formatter-view {
        grid-template-columns: 1fr;
      }

      .diff-inputs {
        grid-template-columns: 1fr;
        height: auto;
      }

      #snippets-view {
        flex-direction: column;
      }

      .snip-sidebar {
        width: 100%;
        height: 280px;
        border-right: none;
        border-bottom: 1px solid var(--border);
      }

      header {
        padding: 14px 20px;
        gap: 10px;
      }

      .subtitle {
        display: none;
      }

      footer {
        padding: 12px 20px;
      }
    }
  </style>
</head>

<body>

  <header>
    <div class="logo">{ }</div>
    <h1>JSON <span>Formatter</span></h1>
    <div class="tabs">
      <button class="tab-btn active" id="tab-formatter" onclick="switchTab('formatter')">‚äû Formatter</button>
      <button class="tab-btn" id="tab-diff" onclick="switchTab('diff')">‚áÑ Diff</button>
      <button class="tab-btn" id="tab-snippets" onclick="switchTab('snippets')">üóÇ Snippets<span class="tab-badge"
          id="snip-badge">0</span></button>
    </div>
    <span class="subtitle">NO BACKEND ¬∑ 100% CLIENT-SIDE</span>
  </header>

  <!-- ‚ïê‚ïê FORMATTER ‚ïê‚ïê -->
  <div id="formatter-view" class="active">
    <div class="panel">
      <div class="panel-header">
        <span class="panel-label">Input</span>
        <div class="panel-actions">
          <button onclick="clearInput()">‚úï Clear</button>
          <button onclick="pasteFromClipboard()">‚åò Paste</button>
          <button class="primary" onclick="convert()">‚ñ∂ Convert</button>
        </div>
      </div>
      <textarea id="input" placeholder='Paste raw JSON string di sini...

Contoh:
{"key":"value","list":[{"a":1}]}

Atau string yang ter-escape seperti:
"{\"billingAddress\":\"...\"}"'></textarea>
    </div>
    <div class="panel">
      <div class="panel-header">
        <span class="panel-label">Output ¬∑ JSON</span>
        <div class="panel-actions">
          <button onclick="copyOutput()">‚éò Copy</button>
          <button onclick="downloadJSON()">‚Üì Download</button>
          <button onclick="openSaveModal('formatter')" title="Save as Snippet">üìå Save</button>
        </div>
      </div>
      <div id="output-area">
        <div class="empty-state">
          <div class="icon">{ }</div>
          <div>Hasil akan muncul di sini</div>
        </div>
      </div>
    </div>
  </div>

  <!-- ‚ïê‚ïê DIFF ‚ïê‚ïê -->
  <div id="diff-view">
    <div class="diff-inputs">
      <div class="panel">
        <div class="panel-header">
          <span class="panel-label" style="color:var(--removed);">‚ñ∂ JSON A</span>
          <div class="panel-actions">
            <button onclick="clearDiffA()">‚úï</button>
            <button onclick="pasteDiffA()">‚åò Paste</button>
            <button onclick="openSaveModal('diff-a')" title="Save JSON A as Snippet">üìå</button>
            <button class="swap-btn" title="Swap A ‚Üî B" onclick="swapInputs()">‚áÑ</button>
          </div>
        </div>
        <textarea id="diff-input-a" class="diff-ta" placeholder='Paste JSON pertama (baseline)...'></textarea>
      </div>
      <div class="panel">
        <div class="panel-header">
          <span class="panel-label" style="color:var(--added);">‚ñ∂ JSON B</span>
          <div class="panel-actions">
            <button onclick="clearDiffB()">‚úï</button>
            <button onclick="pasteDiffB()">‚åò Paste</button>
            <button onclick="openSaveModal('diff-b')" title="Save JSON B as Snippet">üìå</button>
            <button class="primary" onclick="runDiff()">‚áÑ Compare</button>
          </div>
        </div>
        <textarea id="diff-input-b" class="diff-ta" placeholder='Paste JSON kedua (perbandingan)...'></textarea>
      </div>
    </div>
    <div class="diff-output-wrap">
      <div class="panel-header">
        <span class="panel-label">Diff Output</span>
        <div class="panel-actions" id="diff-output-actions" style="display:none">
          <button onclick="copyDiffText()">‚éò Copy Diff</button>
        </div>
      </div>
      <div id="diff-summary" class="diff-summary" style="display:none"></div>
      <div id="diff-output">
        <div class="empty-state">
          <div class="icon">‚áÑ</div>
          <div>Masukkan dua JSON lalu klik Compare</div>
        </div>
      </div>
    </div>
  </div>

  <!-- ‚ïê‚ïê SNIPPETS ‚ïê‚ïê -->
  <div id="snippets-view">
    <div class="snip-sidebar">
      <div class="snip-sidebar-header">
        <input type="text" id="snip-search" class="snip-search" placeholder="üîç  Cari snippet..."
          oninput="renderSnipList()">
      </div>
      <div class="snip-list" id="snip-list"></div>
    </div>
    <div class="snip-preview">
      <div class="snip-preview-header" id="snip-preview-header" style="display:none">
        <span class="snip-preview-title" id="snip-preview-title"></span>
        <div class="snip-preview-actions" id="snip-preview-actions"></div>
      </div>
      <div class="snip-preview-body" id="snip-preview-body">
        <div class="snip-no-sel">
          <div class="icon">üóÇ</div>
          <div>Pilih snippet dari daftar untuk preview</div>
        </div>
      </div>
    </div>
  </div>

  <!-- ‚ïê‚ïê SAVE MODAL ‚ïê‚ïê -->
  <div class="modal-overlay" id="save-modal">
    <div class="modal-box">
      <div class="modal-title">üìå Save Snippet</div>
      <div>
        <div class="modal-label">NAMA SNIPPET</div>
        <input type="text" id="modal-name" class="modal-input" placeholder="cth: Order API Response v2" maxlength="60">
      </div>
      <div class="modal-actions">
        <button onclick="closeSaveModal()">Batal</button>
        <button class="primary" onclick="confirmSave()">‚úì Simpan</button>
      </div>
    </div>
  </div>

  <footer>
    <span id="footer-hint">Drag &amp; Drop file JSON juga didukung</span>
    <span id="status"></span>
    <span id="diff-status"></span>
  </footer>
  <div class="toast" id="toast"></div>

  <script>
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //  UTILITIES
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    let parsedData = null;
    let currentTab = 'formatter';

    function showToast(msg) {
      const t = document.getElementById('toast');
      t.textContent = msg; t.classList.add('show');
      setTimeout(() => t.classList.remove('show'), 2200);
    }
    function setStatus(msg, type) {
      const s = document.getElementById('status');
      s.textContent = msg; s.className = type;
    }
    function setDiffStatus(msg, type) {
      const s = document.getElementById('diff-status');
      s.textContent = msg; s.className = type;
    }
    function esc(s) {
      return String(s).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
    }
    function uid() {
      return Date.now().toString(36) + Math.random().toString(36).slice(2);
    }
    function fmtDate(iso) {
      const d = new Date(iso);
      return d.toLocaleDateString('id-ID', { day: '2-digit', month: 'short', year: 'numeric' }) + ' ' +
        d.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' });
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //  TAB SWITCHING
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function switchTab(tab) {
      currentTab = tab;
      ['formatter', 'diff', 'snippets'].forEach(t => {
        document.getElementById(t + '-view').classList.toggle('active', t === tab);
        document.getElementById('tab-' + t).classList.toggle('active', t === tab);
      });
      document.getElementById('status').style.display = tab === 'formatter' ? '' : 'none';
      document.getElementById('diff-status').style.display = tab === 'diff' ? '' : 'none';
      const hints = { formatter: 'Drag & Drop file JSON juga didukung', diff: 'Masukkan dua JSON lalu klik Compare', snippets: 'Snippet tersimpan di browser ‚Äî tidak dikirim ke server' };
      document.getElementById('footer-hint').textContent = hints[tab];
      if (tab === 'snippets') renderSnipList();
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //  JSON PARSER
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function tryParse(raw) {
      raw = raw.trim().replace(/,\s*$/, '');
      const attempts = [
        () => JSON.parse(raw),
        () => { let s = raw; if ((s[0] === '"' && s.slice(-1) === '"') || (s[0] === "'" && s.slice(-1) === "'")) s = s.slice(1, -1); return JSON.parse(s); },
        () => { let s = raw; if ((s[0] === '"' && s.slice(-1) === '"') || (s[0] === "'" && s.slice(-1) === "'")) s = s.slice(1, -1); s = s.replace(/\\"/g, '"').replace(/\\\\/g, '\\'); return JSON.parse(s); },
        () => { const w = '"' + raw.replace(/\\/g, '\\\\').replace(/"/g, '\\"') + '"'; return JSON.parse(JSON.parse(w)); },
        () => { return JSON.parse(JSON.parse('"' + raw + '"')); },
        () => { const m = raw.match(/(\{[\s\S]*\}|\[[\s\S]*\])/); if (!m) throw 0; return JSON.parse(m[1]); },
        () => { let s = raw.replace(/^["']|["']$/g, '').replace(/\\"/g, '"').replace(/\\\\/g, '\\'); const m = s.match(/(\{[\s\S]*\}|\[[\s\S]*\])/); if (!m) throw 0; return JSON.parse(m[1]); },
        () => { let s = raw.replace(/^["']|["']$/g, '').replace(/\\"/g, '"').replace(/\\\\/g, '\\'); return JSON.parse(s); }
      ];
      for (const fn of attempts) { try { const r = fn(); if (r != null) return r; } catch (e) { } }
      throw new Error('Tidak dapat mem-parse input.');
    }

    function syntaxHL(json) {
      const e = json.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
      return e.replace(/(\"(\\u[\da-fA-F]{4}|\\[^u]|[^\\"])*\"(\s*:)?|true|false|null|-?\d+\.?\d*([eE][+-]?\d+)?)/g, m => {
        if (/^"/.test(m)) return /:$/.test(m) ? `<span class="j-key">${m}</span>` : `<span class="j-str">${m}</span>`;
        if (/true|false/.test(m)) return `<span class="j-bool">${m}</span>`;
        if (/null/.test(m)) return `<span class="j-null">${m}</span>`;
        return `<span class="j-num">${m}</span>`;
      }).replace(/(?<!["\\w])[{}\[\]](?!["\\w])/g, b => `<span class="j-brk">${b}</span>`);
    }
    function countKeys(obj, c = 0) { if (typeof obj === 'object' && obj !== null) { for (const k in obj) { c++; c = countKeys(obj[k], c); } } return c; }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //  FORMATTER
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function convert() {
      const raw = document.getElementById('input').value;
      const out = document.getElementById('output-area');
      if (!raw.trim()) {
        out.innerHTML = '<div class="empty-state"><div class="icon">{ }</div><div>Input kosong</div></div>';
        setStatus('', ''); parsedData = null; return;
      }
      try {
        parsedData = tryParse(raw);
        out.innerHTML = `<pre>${syntaxHL(JSON.stringify(parsedData, null, 2))}</pre>`;
        setStatus(`‚úì ${countKeys(parsedData)} keys ¬∑ valid JSON`, 'ok');
        // Auto-history
        saveHistory(parsedData, raw, 'formatter');
      } catch (e) {
        const pv = s => s.substring(0, 100).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
        const codes = [...raw.substring(0, 6)].map(c => `\\u${c.charCodeAt(0).toString(16).padStart(4, '0')}`).join(' ');
        out.innerHTML = `<div class="error-msg">‚ö† Gagal mem-parse input.<br><br><b>Debug:</b><br>‚Ä¢ Panjang: ${raw.length} char<br>‚Ä¢ Awal: <code>${pv(raw)}</code><br>‚Ä¢ Char codes: <code>${codes}</code></div><div style="padding:14px 20px;font-size:11px;color:var(--muted);font-family:'JetBrains Mono',monospace;line-height:1.8">üí° <b>Tips:</b><br>‚Äî Pastikan copy dari { sampai } saja<br>‚Äî Hapus koma di akhir jika ada</div>`;
        setStatus('‚úó Parse error', 'err'); parsedData = null;
      }
    }
    function copyOutput() { if (!parsedData) { showToast('Tidak ada output'); return; } navigator.clipboard.writeText(JSON.stringify(parsedData, null, 2)).then(() => showToast('‚úì Copied!')).catch(() => showToast('Gagal copy')); }
    function downloadJSON() { if (!parsedData) { showToast('Tidak ada data'); return; } const b = new Blob([JSON.stringify(parsedData, null, 2)], { type: 'application/json' }); const a = document.createElement('a'); a.href = URL.createObjectURL(b); a.download = 'output.json'; a.click(); showToast('‚úì Download dimulai!'); }
    function clearInput() { document.getElementById('input').value = ''; document.getElementById('output-area').innerHTML = '<div class="empty-state"><div class="icon">{ }</div><div>Hasil akan muncul di sini</div></div>'; setStatus('', ''); parsedData = null; }
    async function pasteFromClipboard() { try { document.getElementById('input').value = await navigator.clipboard.readText(); showToast('‚úì Pasted!'); } catch (e) { showToast('Izin clipboard ditolak'); } }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //  DIFF ENGINE
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    let lastDiffs = [];
    function getType(v) { if (v === null) return 'null'; if (Array.isArray(v)) return 'array'; if (typeof v === 'object') return 'object'; return 'primitive'; }
    function collectAll(val, path, type, res) {
      const t = getType(val);
      if (t === 'object') { for (const k of Object.keys(val)) collectAll(val[k], `${path}.${k}`, type, res); }
      else if (t === 'array') { val.forEach((it, i) => collectAll(it, `${path}[${i}]`, type, res)); }
      else { if (type === 'added') res.push({ path, type: 'added', newVal: val }); if (type === 'removed') res.push({ path, type: 'removed', oldVal: val }); }
    }
    function diffJSON(a, b, path = '') {
      const res = []; const tA = getType(a), tB = getType(b);
      if (tA === 'object' && tB === 'object') {
        const keys = new Set([...Object.keys(a), ...Object.keys(b)]);
        for (const k of keys) { const cp = path ? `${path}.${k}` : k; if (!(k in a)) collectAll(b[k], cp, 'added', res); else if (!(k in b)) collectAll(a[k], cp, 'removed', res); else res.push(...diffJSON(a[k], b[k], cp)); }
      } else if (tA === 'array' && tB === 'array') {
        const mx = Math.max(a.length, b.length);
        for (let i = 0; i < mx; i++) { const cp = `${path}[${i}]`; if (i >= a.length) collectAll(b[i], cp, 'added', res); else if (i >= b.length) collectAll(a[i], cp, 'removed', res); else res.push(...diffJSON(a[i], b[i], cp)); }
      } else {
        if (JSON.stringify(a) !== JSON.stringify(b)) res.push({ path, type: 'changed', oldVal: a, newVal: b });
      }
      return res;
    }
    function rdv(v) { if (v === null) return `<span style="color:var(--null)">null</span>`; if (typeof v === 'boolean') return `<span style="color:var(--bool)">${v}</span>`; if (typeof v === 'number') return `<span style="color:var(--number)">${v}</span>`; return `<span style="color:var(--string)">${esc(JSON.stringify(v))}</span>`; }

    function runDiff() {
      const rA = document.getElementById('diff-input-a').value, rB = document.getElementById('diff-input-b').value;
      const out = document.getElementById('diff-output'), sumEl = document.getElementById('diff-summary'), actEl = document.getElementById('diff-output-actions');
      if (!rA.trim() || !rB.trim()) { out.innerHTML = '<div class="empty-state"><div class="icon">‚áÑ</div><div>Kedua input harus diisi</div></div>'; sumEl.style.display = 'none'; actEl.style.display = 'none'; setDiffStatus('', ''); return; }
      let oA, oB;
      try { oA = tryParse(rA); } catch (e) { out.innerHTML = `<div class="error-msg">‚ö† JSON A tidak valid</div>`; sumEl.style.display = 'none'; actEl.style.display = 'none'; setDiffStatus('‚úó JSON A error', 'err'); return; }
      try { oB = tryParse(rB); } catch (e) { out.innerHTML = `<div class="error-msg">‚ö† JSON B tidak valid</div>`; sumEl.style.display = 'none'; actEl.style.display = 'none'; setDiffStatus('‚úó JSON B error', 'err'); return; }
      const diffs = diffJSON(oA, oB); lastDiffs = diffs;
      const add = diffs.filter(d => d.type === 'added').length, rem = diffs.filter(d => d.type === 'removed').length, chg = diffs.filter(d => d.type === 'changed').length, idn = Math.max(0, countKeys(oA) - rem - chg);
      sumEl.style.display = 'flex';
      sumEl.innerHTML = `<span class="badge added">Ôºã ${add} added</span><span class="badge removed">‚àí ${rem} removed</span><span class="badge changed">~ ${chg} changed</span><span class="badge identical">= ${idn} identical</span>`;
      if (!diffs.length) { out.innerHTML = '<div class="empty-state"><div class="icon" style="font-size:28px;opacity:.6">‚úì</div><div style="color:var(--accent)">JSON identik</div></div>'; setDiffStatus('‚úì Identical', 'ok'); actEl.style.display = 'none'; return; }
      const groups = { changed: diffs.filter(d => d.type === 'changed'), added: diffs.filter(d => d.type === 'added'), removed: diffs.filter(d => d.type === 'removed') };
      let html = '';
      if (groups.changed.length) { html += `<div class="diff-section-label">~ Changed (${groups.changed.length})</div>`; groups.changed.forEach(d => { html += `<div class="diff-entry changed"><span class="diff-sign">~</span><span class="diff-path" title="${esc(d.path)}">${esc(d.path)}</span><span class="diff-value"><span class="diff-old">${rdv(d.oldVal)}</span><span class="diff-arrow"> ‚Üí </span><span class="diff-new">${rdv(d.newVal)}</span></span></div>`; }); }
      if (groups.added.length) { html += `<div class="diff-section-label">Ôºã Added (${groups.added.length})</div>`; groups.added.forEach(d => { html += `<div class="diff-entry added"><span class="diff-sign">+</span><span class="diff-path" title="${esc(d.path)}">${esc(d.path)}</span><span class="diff-value">${rdv(d.newVal)}</span></div>`; }); }
      if (groups.removed.length) { html += `<div class="diff-section-label">‚àí Removed (${groups.removed.length})</div>`; groups.removed.forEach(d => { html += `<div class="diff-entry removed"><span class="diff-sign">‚àí</span><span class="diff-path" title="${esc(d.path)}">${esc(d.path)}</span><span class="diff-value">${rdv(d.oldVal)}</span></div>`; }); }
      out.innerHTML = html; actEl.style.display = 'flex';
      setDiffStatus(`‚áÑ ${add + rem + chg} difference${add + rem + chg !== 1 ? 's' : ''} found`, 'err');
    }
    function clearDiffA() { document.getElementById('diff-input-a').value = ''; }
    function clearDiffB() { document.getElementById('diff-input-b').value = ''; }
    async function pasteDiffA() { try { document.getElementById('diff-input-a').value = await navigator.clipboard.readText(); showToast('‚úì Pasted to JSON A'); } catch (e) { showToast('Izin clipboard ditolak'); } }
    async function pasteDiffB() { try { document.getElementById('diff-input-b').value = await navigator.clipboard.readText(); showToast('‚úì Pasted to JSON B'); } catch (e) { showToast('Izin clipboard ditolak'); } }
    function swapInputs() { const a = document.getElementById('diff-input-a'), b = document.getElementById('diff-input-b'); const t = a.value; a.value = b.value; b.value = t; showToast('‚úì Swapped!'); }
    function copyDiffText() { if (!lastDiffs.length) { showToast('Tidak ada diff'); return; } const lines = lastDiffs.map(d => d.type === 'added' ? `+ ${d.path}: ${JSON.stringify(d.newVal)}` : d.type === 'removed' ? `- ${d.path}: ${JSON.stringify(d.oldVal)}` : `~ ${d.path}: ${JSON.stringify(d.oldVal)} ‚Üí ${JSON.stringify(d.newVal)}`); navigator.clipboard.writeText(lines.join('\n')).then(() => showToast('‚úì Diff copied!')).catch(() => showToast('Gagal copy')); }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //  SNIPPET STORAGE
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    const SNIP_KEY = 'jf_snippets';
    const HIST_KEY = 'jf_history';
    const HIST_MAX = 10;

    function loadSnippets() { try { return JSON.parse(localStorage.getItem(SNIP_KEY) || '[]'); } catch { return []; } }
    function saveSnippets(arr) { localStorage.setItem(SNIP_KEY, JSON.stringify(arr)); updateBadge(); }
    function loadHistory() { try { return JSON.parse(localStorage.getItem(HIST_KEY) || '[]'); } catch { return []; } }
    function saveHistoryArr(arr) { localStorage.setItem(HIST_KEY, JSON.stringify(arr)); updateBadge(); }

    function updateBadge() {
      const total = loadSnippets().length + loadHistory().length;
      document.getElementById('snip-badge').textContent = total || 0;
    }

    function autoSnipName(obj) {
      if (Array.isArray(obj)) return `Array [${obj.length} items]`;
      const keys = Object.keys(obj || {});
      if (!keys.length) return '{}';
      const first = keys[0];
      const val = obj[first];
      const vStr = typeof val === 'string' ? `"${val.substring(0, 20)}"` : JSON.stringify(val);
      return `${first}: ${vStr}`;
    }

    function saveHistory(obj, raw, source) {
      const hist = loadHistory();
      // Avoid duplicate consecutive saves
      if (hist.length && JSON.stringify(hist[0].json) === JSON.stringify(obj)) return;
      hist.unshift({ id: uid(), name: null, json: obj, raw, source, savedAt: new Date().toISOString(), type: 'history' });
      if (hist.length > HIST_MAX) hist.splice(HIST_MAX);
      saveHistoryArr(hist);
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //  SAVE MODAL
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    let _modalSource = 'formatter';

    function openSaveModal(source) {
      // Validate we have data to save
      let obj, raw;
      if (source === 'formatter') {
        if (!parsedData) { showToast('Tidak ada JSON untuk disimpan'); return; }
        obj = parsedData; raw = JSON.stringify(parsedData, null, 2);
      } else if (source === 'diff-a') {
        raw = document.getElementById('diff-input-a').value.trim();
        if (!raw) { showToast('JSON A kosong'); return; }
        try { obj = tryParse(raw); } catch { showToast('JSON A tidak valid'); return; }
      } else {
        raw = document.getElementById('diff-input-b').value.trim();
        if (!raw) { showToast('JSON B kosong'); return; }
        try { obj = tryParse(raw); } catch { showToast('JSON B tidak valid'); return; }
      }
      _modalSource = source;
      _modalObj = obj; _modalRaw = raw;
      document.getElementById('modal-name').value = '';
      document.getElementById('save-modal').classList.add('open');
      setTimeout(() => document.getElementById('modal-name').focus(), 80);
    }
    let _modalObj = null, _modalRaw = '';

    function closeSaveModal() {
      document.getElementById('save-modal').classList.remove('open');
    }

    function confirmSave() {
      const name = document.getElementById('modal-name').value.trim();
      if (!name) { showToast('Nama tidak boleh kosong'); document.getElementById('modal-name').focus(); return; }
      const snips = loadSnippets();
      snips.unshift({ id: uid(), name, json: _modalObj, raw: _modalRaw, source: _modalSource, savedAt: new Date().toISOString(), type: 'snippet' });
      saveSnippets(snips);
      closeSaveModal();
      showToast(`üìå "${name}" tersimpan!`);
      if (currentTab === 'snippets') renderSnipList();
    }

    // Enter key in modal
    document.addEventListener('keydown', e => {
      if (e.key === 'Escape') closeSaveModal();
      if (e.key === 'Enter' && document.getElementById('save-modal').classList.contains('open')) confirmSave();
    });

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //  SNIPPETS UI
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    let selectedSnipId = null;

    function renderSnipList() {
      const q = document.getElementById('snip-search').value.toLowerCase();
      const snips = loadSnippets().filter(s => !q || s.name.toLowerCase().includes(q) || autoSnipName(s.json).toLowerCase().includes(q));
      const hist = loadHistory().filter(s => !q || autoSnipName(s.json).toLowerCase().includes(q));

      let html = '';
      if (snips.length) {
        html += `<div class="snip-section-title">üìå Saved (${snips.length})</div>`;
        html += snips.map(s => snipCard(s)).join('');
      }
      if (hist.length) {
        html += `<div class="snip-section-title">üïê History (${hist.length} terbaru)</div>`;
        html += hist.map(s => snipCard(s)).join('');
      }
      if (!snips.length && !hist.length) {
        html = `<div class="snip-empty"><div class="ei">üóÇ</div><div>${q ? 'Tidak ditemukan' : 'Belum ada snippet tersimpan'}</div></div>`;
      }
      document.getElementById('snip-list').innerHTML = html;
    }

    function snipCard(s) {
      const name = s.name || autoSnipName(s.json);
      const preview = JSON.stringify(s.json).substring(0, 60);
      const srcLabel = { 'formatter': 'FORMATTER', 'diff-a': 'DIFF A', 'diff-b': 'DIFF B' }[s.source] || s.source;
      const sel = s.id === selectedSnipId ? 'selected' : '';
      return `<div class="snip-card ${sel}" id="sc-${s.id}" onclick="selectSnip('${s.id}','${s.type}')">
    <div class="snip-card-name"><span>${esc(name)}</span><span class="snip-source-badge ${s.source}">${srcLabel}</span></div>
    <div class="snip-card-preview">${esc(preview)}${preview.length >= 60 ? '‚Ä¶' : ''}</div>
    <div class="snip-card-meta"><span>${fmtDate(s.savedAt)}</span></div>
  </div>`;
    }

    function selectSnip(id, type) {
      selectedSnipId = id;
      renderSnipList();
      const arr = type === 'snippet' ? loadSnippets() : loadHistory();
      const s = arr.find(x => x.id === id);
      if (!s) return;

      const name = s.name || autoSnipName(s.json);
      document.getElementById('snip-preview-header').style.display = 'flex';
      document.getElementById('snip-preview-title').textContent = name;
      document.getElementById('snip-preview-body').innerHTML = `<pre>${syntaxHL(JSON.stringify(s.json, null, 2))}</pre>`;

      // Action buttons
      let acts = `<button onclick="loadSnip('${id}','${type}','formatter')">‚Üó Load ke Formatter</button>
    <button onclick="loadSnip('${id}','${type}','diff-a')">‚Üó Diff A</button>
    <button onclick="loadSnip('${id}','${type}','diff-b')">‚Üó Diff B</button>
    <button onclick="copySnip('${id}','${type}')">‚éò Copy</button>`;
      if (type === 'history') acts += `<button class="primary" onclick="promoteToSnippet('${id}')">üìå Save</button>`;
      acts += `<button class="danger" onclick="deleteSnip('${id}','${type}')">üóë</button>`;
      document.getElementById('snip-preview-actions').innerHTML = acts;
    }

    function loadSnip(id, type, dest) {
      const arr = type === 'snippet' ? loadSnippets() : loadHistory();
      const s = arr.find(x => x.id === id);
      if (!s) return;
      const pretty = JSON.stringify(s.json, null, 2);
      if (dest === 'formatter') {
        document.getElementById('input').value = pretty;
        switchTab('formatter');
        convert();
        showToast('‚úì Loaded ke Formatter');
      } else if (dest === 'diff-a') {
        document.getElementById('diff-input-a').value = pretty;
        switchTab('diff');
        showToast('‚úì Loaded ke JSON A');
      } else {
        document.getElementById('diff-input-b').value = pretty;
        switchTab('diff');
        showToast('‚úì Loaded ke JSON B');
      }
    }

    function copySnip(id, type) {
      const arr = type === 'snippet' ? loadSnippets() : loadHistory();
      const s = arr.find(x => x.id === id);
      if (!s) return;
      navigator.clipboard.writeText(JSON.stringify(s.json, null, 2)).then(() => showToast('‚úì Copied!')).catch(() => showToast('Gagal copy'));
    }

    function deleteSnip(id, type) {
      if (type === 'snippet') {
        const arr = loadSnippets().filter(x => x.id !== id);
        saveSnippets(arr);
      } else {
        const arr = loadHistory().filter(x => x.id !== id);
        saveHistoryArr(arr);
      }
      if (selectedSnipId === id) {
        selectedSnipId = null;
        document.getElementById('snip-preview-header').style.display = 'none';
        document.getElementById('snip-preview-body').innerHTML = '<div class="snip-no-sel"><div class="icon">üóÇ</div><div>Pilih snippet dari daftar untuk preview</div></div>';
      }
      renderSnipList();
      showToast('üóë Dihapus');
    }

    function promoteToSnippet(histId) {
      const hist = loadHistory();
      const s = hist.find(x => x.id === histId);
      if (!s) return;
      _modalObj = s.json; _modalRaw = JSON.stringify(s.json, null, 2); _modalSource = s.source;
      document.getElementById('modal-name').value = autoSnipName(s.json);
      document.getElementById('save-modal').classList.add('open');
      setTimeout(() => document.getElementById('modal-name').focus(), 80);
    }

    // Close modal on overlay click
    document.getElementById('save-modal').addEventListener('click', e => { if (e.target === e.currentTarget) closeSaveModal(); });

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //  KEYBOARD
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    document.addEventListener('keydown', e => {
      if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
        if (currentTab === 'formatter') convert();
        else if (currentTab === 'diff') runDiff();
      }
    });

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //  DRAG & DROP
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    document.addEventListener('dragover', e => e.preventDefault());
    document.addEventListener('drop', e => {
      e.preventDefault();
      const file = e.dataTransfer.files[0]; if (!file) return;
      const reader = new FileReader();
      reader.onload = ev => {
        if (currentTab === 'formatter') { document.getElementById('input').value = ev.target.result; convert(); }
        else if (currentTab === 'diff') { document.getElementById('diff-input-a').value = ev.target.result; }
      };
      reader.readAsText(file);
      showToast(`üìÇ ${file.name} dimuat`);
    });

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //  INIT
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    document.getElementById('diff-status').style.display = 'none';
    document.getElementById('status').style.display = '';
    updateBadge();
  </script>
</body>

</html>